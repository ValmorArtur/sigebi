<div th:fragment="conteudo" class="bg-white rounded-lg shadow-md p-6 relative">
  <!-- Ícone do módulo -->
  <div th:replace="~{fragments/card-icone :: iconeCard('/img/icon-publisher-azul.png')}"></div>

  <!-- Cabeçalho com título centralizado -->
  <div class="flex justify-between items-center mb-2">
    <div class="absolute left-1/2 transform -translate-x-1/2 mt-14">
      <h1 class="text-2xl font-bold text-gray-800 flex items-center">
        <span class="relative inline-block">
          <span class="absolute w-[18px] h-[18px] bg-yellow-400 rounded-sm -left-2 top-[2px] z-0"></span>
          <span class="relative z-10">E</span>
        </span><span th:text="${editora.idEditora != null ? 'ditora - Edição' : 'ditora - Inclusão'}"></span>
      </h1>
    </div>
  </div>

  <!-- Linha separadora amarela -->
  <div class="h-1 bg-yellow-400 mb-4 mt-14 rounded-sm"></div>

  <!-- Mensagens -->
  <div th:if="${mensagem}" class="hidden" data-flash="2000" data-kind="success" th:text="${mensagem}"></div>
  <div th:if="${sucesso}" class="hidden" data-flash="2000" data-kind="success" th:text="${sucesso}"></div>
  <div th:if="${erro}" class="hidden" data-flash="5000" data-kind="error" th:text="${erro}"></div>

  <!-- Formulário -->
  <form id="formEditora" th:action="@{/editora/salvar}" method="post" th:object="${editora}" class="space-y-4">
    <!-- CSRF -->
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
    <input type="hidden" th:field="*{idEditora}" />

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <label class="block text-gray-700 font-semibold">Nome</label>
        <input th:field="*{nomeEditora}" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm
                      focus:outline-none focus:ring-1 focus:ring-yellow-400 focus:border-yellow-400" />
      </div>

      <div class="relative pb-5">
        <label class="block text-gray-700 font-semibold">Telefone</label>
        <input type="text" th:field="*{foneEditora}" id="foneEditora" maxlength="15" inputmode="numeric"
          aria-invalid="false" aria-describedby="erroFoneEditora" autocomplete="tel" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm
                focus:outline-none focus:ring-1 focus:ring-yellow-400 focus:border-yellow-400" required>
        <p id="erroFoneEditora" class="text-red-600 text-sm leading-5 h-5 whitespace-nowrap overflow-hidden text-ellipsis hidden
            absolute left-0 bottom-0">
          Telefone inválido. Use DDD + número (10 ou 11 dígitos).
        </p>
      </div>


      <!-- Endereço -->
      <div>
        <label class="block text-gray-700 font-semibold">CEP</label>
        <input th:field="*{cepEditora}" id="cepEditora" inputmode="numeric" maxlength="9" placeholder="00000-000" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm
                      focus:outline-none focus:ring-1 focus:ring-yellow-400 focus:border-yellow-400" />
        <small id="alertCep"
          class="hidden text-red-700 bg-red-100 border border-red-400 px-2 py-1 rounded mt-1 inline-block">
          CEP inválido ou não encontrado.
        </small>
      </div>

      <div>
        <label class="block text-gray-700 font-semibold">Rua</label>
        <input th:field="*{ruaEditora}" id="ruaEditora" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm
                      focus:outline-none focus:ring-1 focus:ring-yellow-400 focus:border-yellow-400" />
      </div>

      <div>
        <label class="block text-gray-700 font-semibold">Número</label>
        <input th:field="*{numeroEditora}" id="numeroEditora" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm
                      focus:outline-none focus:ring-1 focus:ring-yellow-400 focus:border-yellow-400" />
      </div>

      <div>
        <label class="block text-gray-700 font-semibold">Bairro</label>
        <input th:field="*{bairroEditora}" id="bairroEditora" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm
                      focus:outline-none focus:ring-1 focus:ring-yellow-400 focus:border-yellow-400" />
      </div>

      <div>
        <label class="block text-gray-700 font-semibold">Cidade</label>
        <input th:field="*{cidadeEditora}" id="cidadeEditora" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm
                      focus:outline-none focus:ring-1 focus:ring-yellow-400 focus:border-yellow-400" />
      </div>

      <div>
        <label class="block text-gray-700 font-semibold">Estado</label>
        <input th:field="*{estadoEditora}" id="estadoEditora" maxlength="2" placeholder="UF" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm
                      focus:outline-none focus:ring-1 focus:ring-yellow-400 focus:border-yellow-400 uppercase" />
      </div>

      <div class="md:col-span-2">
        <label class="block text-gray-700 font-semibold">Site</label>
        <input type="url" th:field="*{siteEditora}" id="siteEditora" placeholder="https://exemplo.com" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm
                focus:outline-none focus:ring-1 focus:ring-yellow-400 focus:border-yellow-400" />
        <small id="alertSite"
          class="hidden text-red-700 bg-red-100 border border-red-400 px-2 py-1 rounded mt-1 inline-block">
          Informe uma URL válida iniciando com http:// ou https://
        </small>
        <!-- Erros vindos do back-end (Bean Validation) -->
        <div class="text-red-600 text-sm" th:if="${#fields.hasErrors('siteEditora')}" th:errors="*{siteEditora}"></div>
      </div>

      <!-- Ativo: sempre visível -->
      <div class="flex items-center gap-2">
        <input th:field="*{ativo}" type="checkbox" class="transform scale-150 accent-blue-800" />
        <label class="text-gray-700 font-semibold">Ativo</label>
      </div>
    </div>

    <!-- Botões -->
    <div class="flex justify-end mt-8 space-x-2">
      <button type="reset" class="bg-gray-500 hover:bg-gray-600 text-white px-5 py-2 rounded">Limpar</button>
      <a href="/editora"
        class="bg-gray-400 text-white px-5 py-2 rounded hover:bg-gray-500 inline-flex items-center justify-center">Cancelar</a>
      <button type="submit" class="bg-[#2d3e50] hover:bg-[#1f2d3a] text-white px-6 py-2 rounded">Salvar</button>
    </div>
  </form>

  <!-- Scripts -->
  <script>
    // --- Utilitários de máscara ---
    function somenteDigitos(e) {
      const allowed = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Home', 'End'];
      const isCtrlCmd = e.ctrlKey || e.metaKey;
      if (allowed.includes(e.key) || (isCtrlCmd && ['a', 'c', 'v', 'x'].includes(e.key.toLowerCase()))) return;
      if (!/\d/.test(e.key)) e.preventDefault();
    }

    // Formata a partir de "apenas dígitos"
    function formatTelefoneFromDigits(d) {
      if (d.length <= 10) {
        // (99) 9999-9999
        return d
          .replace(/^(\d{0,2})(\d{0,4})(\d{0,4}).*$/, (m, a, b, c) =>
            [a ? `(${a}` : '', a && a.length === 2 ? ') ' : '', b, b && c ? '-' : '', c].join('')
          );
      }
      // (99) 99999-9999
      return d
        .replace(/^(\d{0,2})(\d{0,5})(\d{0,4}).*$/, (m, a, b, c) =>
          [a ? `(${a}` : '', a && a.length === 2 ? ') ' : '', b, b && c ? '-' : '', c].join('')
        );
    }

    // aplica a máscara dinâmica usando o formatador acima
    function aplicarMascaraTelefoneDinamica(el) {
      const d = el.value.replace(/\D/g, '');
      el.value = formatTelefoneFromDigits(d);
    }


    function maskCep(v) {
      v = v.replace(/\D/g, '').slice(0, 8);
      if (v.length > 5) return v.replace(/^(\d{5})(\d{0,3}).*/, '$1-$2');
      return v;
    }

    function onlyDigits(s) { return (s || '').replace(/\D/g, ''); }

    // --- ViaCEP com debounce ---
    let cepTimer = null;
    let lastFetchedCep = '';

    async function fetchViaCep(cepDigits) {

      if (!navigator.onLine) {
        // se estiver Offline: 
        console.warn("Sem internet: preencha o endereço manualmente.");
        alert("Sem internet: preencha o endereço manualmente.");
        return; // não chama ViaCEP
      }

      try {
        const resp = await fetch(`https://viacep.com.br/ws/${cepDigits}/json/`);
        const data = await resp.json();
        if (data.erro) return { ok: false };
        return {
          ok: true,
          rua: data.logradouro || '',
          bairro: data.bairro || '',
          cidade: data.localidade || '',
          uf: data.uf || ''
        };
      } catch (e) {
        console.error('ViaCEP indisponível. Preencha o endereço manualmente.', e);
        return { ok: false };
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      const fone = document.getElementById('foneEditora');
      const cep = document.getElementById('cepEditora');

      const rua = document.getElementById('ruaEditora');
      const bairro = document.getElementById('bairroEditora');
      const cidade = document.getElementById('cidadeEditora');
      const estado = document.getElementById('estadoEditora');

      const alertCep = document.getElementById('alertCep');
      const msgFoneEditora = document.getElementById('erroFoneEditora');
      let touchedFone = false;


      // Máscara telefone
      // (1) Keydown especial: Backspace/Delete sobre caracteres da máscara
      if (fone) {
        fone.addEventListener("keydown", function (e) {
          const el = this;

          // Deixe passar atalhos e navegação
          const allowed = ['Tab', 'ArrowLeft', 'ArrowRight', 'Home', 'End'];
          const isCtrlCmd = e.ctrlKey || e.metaKey;
          if (allowed.includes(e.key) || (isCtrlCmd && ['a', 'c', 'v', 'x'].includes(e.key.toLowerCase()))) return;

          const val = el.value;
          const selStart = el.selectionStart ?? val.length;
          const selEnd = el.selectionEnd ?? val.length;

          if (selStart !== selEnd) return; // seleção: comportamento padrão

          if (e.key === 'Backspace' || e.key === 'Delete') {
            const idx = e.key === 'Backspace' ? selStart - 1 : selStart;
            const ch = val.charAt(idx);

            if (ch && /\D/.test(ch)) {
              e.preventDefault();
              let digits = val.replace(/\D/g, '');
              if (digits.length === 0) return;

              if (e.key === 'Backspace') {
                digits = digits.slice(0, -1); // remove último dígito
              } else {
                digits = digits.slice(1);     // remove primeiro dígito
              }
              el.value = formatTelefoneFromDigits(digits);
              el.setSelectionRange(el.value.length, el.value.length);
              return;
            }
          }

          // mantém "somente números" para teclas imprimíveis
          if (e.key.length === 1 && !/\d/.test(e.key)) e.preventDefault();
        });
      }

      // (2) Input: aplica máscara e marca como "tocado"
      if (fone) {
        fone.addEventListener("keydown", somenteDigitos); // igual ao usuário/form
        fone.addEventListener("input", () => {
          aplicarMascaraTelefoneDinamica(fone);
          touchedFone = true;
        });
        fone.addEventListener("change", () => { touchedFone = true; });
      }

      // (3) Blur: valida como no usuário/form
      if (fone) {
        fone.addEventListener("blur", () => {
          const valor = fone.value.trim();

          if (valor === "") {
            // sem valor: limpa erro visual
            fone.classList.remove("border-red-500");
            fone.setAttribute("aria-invalid", "false");
            if (msgFoneEditora) msgFoneEditora.classList.add("hidden");
            return;
          }

          if (!touchedFone) return;

          const d = valor.replace(/\D/g, '');
          const ok = (d.length === 10 || d.length === 11);

          if (!ok) {
            fone.classList.add("border-red-500");
            fone.setAttribute("aria-invalid", "true");
            if (msgFoneEditora) {
              msgFoneEditora.textContent = "Telefone inválido. Use DDD + número (10 ou 11 dígitos).";
              msgFoneEditora.classList.remove("hidden");
            }
            setTimeout(() => { fone.focus(); fone.select(); }, 0);
          } else {
            fone.classList.remove("border-red-500");
            fone.setAttribute("aria-invalid", "false");
            if (msgFoneEditora) msgFoneEditora.classList.add("hidden");
          }
        });
      }


      // Máscara e busca automática CEP
      if (cep) {
        const tryFetch = async () => {
          const digits = onlyDigits(cep.value);
          if (digits.length === 8 && digits !== lastFetchedCep) {
            lastFetchedCep = digits;
            alertCep.classList.add('hidden');
            const res = await fetchViaCep(digits);
            if (res.ok) {
              if (rua) rua.value = res.rua;
              if (bairro) bairro.value = res.bairro;
              if (cidade) cidade.value = res.cidade;
              if (estado) estado.value = res.uf;
            } else {
              alertCep.classList.remove('hidden');
            }
          }
        };

        cep.addEventListener('input', (e) => {
          e.target.value = maskCep(e.target.value);
          clearTimeout(cepTimer);
          cepTimer = setTimeout(tryFetch, 300); // debounce 300ms
        });

        cep.addEventListener('blur', tryFetch);
      }

      // Validação no submit
      const form = document.getElementById('formEditora');
      form.addEventListener('submit', function (e) {
        // CEP: se preenchido, precisa ter 8 dígitos
        if (cep && cep.value.trim() !== '') {
          const digits = onlyDigits(cep.value);
          if (digits.length !== 8) {
            e.preventDefault();
            alertCep.classList.remove('hidden');
            cep.focus();
            return false;
          }
        }

        // Telefone: se preenchido, 10 ou 11 dígitos
        // Telefone: se preenchido, 10 ou 11 dígitos (mesma regra do usuário/form)
        if (fone && fone.value.trim() !== '') {
          const d = fone.value.replace(/\D/g, '');
          const ok = (d.length === 10 || d.length === 11);
          if (!ok) {
            e.preventDefault();
            fone.classList.add("border-red-500");
            fone.setAttribute("aria-invalid", "true");
            if (msgFoneEditora) {
              msgFoneEditora.textContent = "Telefone inválido. Use DDD + número (10 ou 11 dígitos).";
              msgFoneEditora.classList.remove("hidden");
            }
            fone.focus();
            return false;
          } else {
            fone.classList.remove("border-red-500");
            fone.setAttribute("aria-invalid", "false");
            if (msgFoneEditora) msgFoneEditora.classList.add("hidden");
          }
        }

      });
    });

    // --- Normalização/validação de URL ---
    function normalizeUrl(v) {
      v = (v || '').trim();
      if (v === '') return '';
      // se não começou com http/https, prefixa https://
      if (!/^https?:\/\//i.test(v)) v = 'https://' + v;
      return v;
    }

    function isValidHttpUrl(s) {
      try {
        const u = new URL(s);
        return u.protocol === 'http:' || u.protocol === 'https:';
      } catch (e) {
        return false;
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('formEditora');
      const site = document.getElementById('siteEditora');
      const alertSite = document.getElementById('alertSite');

      if (site) {
        site.addEventListener('blur', () => {
          const normalized = normalizeUrl(site.value);
          site.value = normalized;
          if (normalized && !isValidHttpUrl(normalized)) {
            alertSite.classList.remove('hidden');
          } else {
            alertSite.classList.add('hidden');
          }
        });
      }

      // No submit, valida Site também
      form.addEventListener('submit', function (e) {
        if (site && site.value.trim() !== '') {
          const normalized = normalizeUrl(site.value);
          site.value = normalized;
          if (!isValidHttpUrl(normalized)) {
            e.preventDefault();
            alertSite.classList.remove('hidden');
            site.focus();
            return false;
          }
        }
      });
    });

  </script>
</div>