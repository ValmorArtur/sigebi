<div th:fragment="conteudo" class="bg-white rounded-lg shadow-md p-6 relative">
  <div th:replace="~{fragments/card-icone :: iconeCard('/img/icon-exemplar-azul.png')}"></div>

  <div class="flex justify-between items-center mb-2">
    <div class="absolute left-1/2 transform -translate-x-1/2 mt-14">
      <h1 class="text-2xl font-bold text-gray-800 flex items-center">
        <span class="relative inline-block">
          <span class="absolute w-[18px] h-[18px] bg-yellow-400 rounded-sm -left-2 top-[2px] z-0"></span>
          <span class="relative z-10">E</span>
        </span>
        <span th:text="${exemplar.idTombo != null ? 'xemplar - Edição' : 'xemplar - Inclusão'}"></span>
      </h1>
    </div>
  </div>

  <div class="h-1 bg-yellow-400 mb-4 mt-14 rounded-sm"></div>

  <!-- Mensagens -->
  <div th:if="${mensagem}" class="hidden" data-flash="2000" data-kind="success" th:text="${mensagem}"></div>
  <div th:if="${sucesso}" class="hidden" data-flash="2000" data-kind="success" th:text="${sucesso}"></div>
  <div th:if="${erro}" class="hidden" data-flash="5000" data-kind="error" th:text="${erro}"></div>


  <form th:action="@{/exemplar/salvar}" th:object="${exemplar}" method="post" class="space-y-6">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
    <input type="hidden" th:field="*{idTombo}" />

    <!-- Mostra idTombo só na EDIÇÃO (read-only). Na inclusão ele será gerado no service -->
    <div th:if="${exemplar.idTombo != null}">
      <label class="block text-sm font-medium text-gray-700">Tombo</label>
      <input th:value="${exemplar.idTombo}" readonly class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm
                    bg-gray-100 text-gray-700 select-all" />
    </div>

    <!-- Acervo -->
    <div>
      <label class="block text-sm font-medium text-gray-700">Acervo <span class="text-red-600">*</span></label>
      <select th:field="*{acervo.idAcervo}" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm
                     focus:outline-none focus:ring-1 focus:ring-yellow-400 focus:border-yellow-400">
        <option value="" disabled th:selected="*{acervo} == null">Selecione...</option>
        <option th:each="a : ${acervos}" th:value="${a.idAcervo}" th:text="${a.tituloAcervo}"></option>
      </select>
      <div class="text-red-600 text-sm" th:if="${#fields.hasErrors('acervo')}" th:errors="*{acervo}"></div>
      <!-- ➜ Prévia do Tombo (somente na inclusão) -->
      <div th:if="${exemplar.idTombo == null}" id="previewTombo" class="text-sm text-gray-600 mt-1 hidden">
        Próximo tombo: <span class="font-semibold" id="previewTomboValue">—</span>
      </div>
    </div>

    <!-- Situação -->
    <div>
      <label class="block text-sm font-medium text-gray-700">
        Situação <span class="text-red-600">*</span>
      </label>

      <select th:field="*{situacao}" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm
                 focus:outline-none focus:ring-1 focus:ring-yellow-400 focus:border-yellow-400">

        <!-- Opções exceto EMPRESTADO 
        <option th:each="s : ${situacoes}" th:if="${s.name() != 'EMPRESTADO'}" th:value="${s}" th:text="${s.label}">
        </option>-->
        <!-- Se NÃO estiver emprestado: mostra todas as opções, menos EMPRESTADO -->
        <option th:each="s : ${situacoes}"
          th:if="${exemplar.situacao == null or exemplar.situacao.name() != 'EMPRESTADO' and s.name() != 'EMPRESTADO'}"
          th:value="${s}" th:text="${s.label}">
        </option>

        <!-- Se já estiver EMPRESTADO, mostra como selecionado porém desabilitado 
        <option th:if="${exemplar.situacao != null and exemplar.situacao.name() == 'EMPRESTADO'}"
          th:value="${exemplar.situacao}" th:text="${exemplar.situacao.label}" selected disabled>
        </option>-->

        <!-- Se JÁ estiver emprestado: mostra só EMPRESTADO -->
        <option th:if="${exemplar.situacao != null and exemplar.situacao.name() == 'EMPRESTADO'}"
          th:value="${exemplar.situacao}" th:text="${exemplar.situacao.label}" selected>
        </option>
      </select>

      <small class="text-gray-500">
        Para emprestar ou devolver, use o módulo <b>Empréstimos</b>.
      </small>

      <div class="text-red-600 text-sm" th:if="${#fields.hasErrors('situacao')}" th:errors="*{situacao}"></div>
    </div>


    <!-- Observação -->
    <div>
      <label class="block text-sm font-medium text-gray-700">Observação (opcional)</label>
      <textarea th:field="*{observacao}" rows="3" maxlength="255" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm
                       focus:outline-none focus:ring-1 focus:ring-yellow-400 focus:border-yellow-400"
        placeholder="Ex.: capa riscada, páginas amassadas..."></textarea>
    </div>

    <div class="flex justify-end space-x-3">
      <a href="/exemplar" class="bg-gray-400 text-white px-5 py-2 rounded hover:bg-gray-500">Cancelar</a>
      <button type="submit" class="bg-[#2e3f52] hover:bg-[#1f2d3a] text-white px-6 py-2 rounded">Salvar</button>
    </div>
  </form>

  <script th:inline="javascript">
    /*<![CDATA[*/
    (function () {
      // Só mostra prévia na INCLUSÃO
      var isInclusao = /*[[${exemplar.idTombo == null}]]*/ true;
      if (!isInclusao) return;

      var selAcervo = document.getElementById('selAcervo');
      var boxPrev = document.getElementById('previewTombo');
      var valPrev = document.getElementById('previewTomboValue');

      async function carregarPrev() {
        if (!selAcervo || !selAcervo.value) {
          if (boxPrev) boxPrev.classList.add('hidden');
          return;
        }
        try {
          const url = '/exemplar/proximo-tombo?idAcervo=' + encodeURIComponent(selAcervo.value);
          const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
          if (!resp.ok) throw new Error('Erro ao consultar prévia');
          const data = await resp.json();
          if (data.ok && data.proximoTombo) {
            if (valPrev) valPrev.textContent = data.proximoTombo;
            if (boxPrev) boxPrev.classList.remove('hidden');
          } else {
            if (valPrev) valPrev.textContent = '—';
            if (boxPrev) boxPrev.classList.remove('hidden');
          }
        } catch (e) {
          if (valPrev) valPrev.textContent = '—';
          if (boxPrev) boxPrev.classList.remove('hidden');
        }
      }

      if (selAcervo) {
        selAcervo.addEventListener('change', carregarPrev);
        // se já tem um acervo selecionado, busca imediatamente
        if (selAcervo.value) carregarPrev();
      }
    })();
    /*]]>*/
  </script>

</div>